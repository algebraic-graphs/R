---
title: "Simulating data from dags with ralget"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulating data from dags with ralget}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
rm(list = ls())
library(tidyverse)
library(tidygraph)
library(ggraph)
library(patchwork)
library(magrittr)
library(ralget)
devtools::load_all()
```


```{r}
# Add helper functions
product <- function(...) {list(...) %>% reduce(`*`)}
b <- function(m){ e(.func = function(.value){.value * m})}
const <- function(x){function(...){x}}
```


```{r}
Y <-  v("Y", .func = function(...){rnorm(10^3,rsum(...), 10)})
X1 <- v("X1",.func = function(...){rnorm(10^3,rsum(...), 10)})
X2 <- v("X2",.func = function(...){rnorm(10^3,rsum(...), 10)})
Z1 <- v("Z1",.func = function(...){rnorm(10^3,rsum(...), 10)})
```


```{r}
g <- 
   X1 * b(1) * Y + X2*b(1)*Y  +
   Z1*b(1)*Y + Z1*b(1)*X2 
class(g) <- class(g)[-1]
```


```{r}
data <- 
evaluate(g) %>% evaluate() %>% extract_data()
plot(g)

g %>% do_causal(X2 = 2) %>% evaluate() %>% extract_data()

```


```{r}
t <- (v("t1")*v("t2")) +
     (v("t2")*v("t3")) + 
     (v("t3")*v("t4")) + 
     (v("t4")*v("t5"))

t <- t %>% activate("edges") %>% 
     mutate(.attrs = list(1)) %>% 
     activate("nodes")
```

```{r}
l <- g %x% t
plot(l)
```

```{r}
lt <- 
l %>% mutate(name = str_remove(name, "\\-.+")) %>% 
graph_join(g) %>% 
activate("edges") %>%
mutate(.attrs = purrr::map(1, ~ b(1)))  %>%
activate("nodes") %>% get_edge_names() %>% 
activate("nodes")

lt <- 
l %>% 
mutate(.attrs = purrr::map(1, ~ list(.func = function(...){rnorm(10,sum(...) + 100, 10)}))) %>%
activate("edges") %>%
mutate(.attrs = purrr::map(1, ~ b(1)))  %>%
activate("nodes") %>% get_edge_names() %>% 
activate("nodes") 

data <- evaluate(lt) %>% extract_data()
```